#!/bin/sh -e

# https://www.debian.org/doc/manuals/apt-guide/index.en.html
# https://www.debian.org/doc/manuals/apt-offline/index.en.html
# https://github.com/cmuench/pacman-auto-update/blob/master/root/usr/lib/pacman-auto-update/pacman-auto-update

batteryIsEmpty() {
  battery_capacity="/sys/class/power_supply/BAT1/capacity"
	[ -f "$battery_capacity" ] && [ "$(cat "$battery_capacity")" -le 20 ]
}
connectionIsMetered() {
  # nmcli --terse --fields GENERAL.METERED dev show | grep --quiet "yes"
  # if not mobile broadband
	true
}
[ "$1" = "autoupdate" ] && { batteryIsEmpty || connectionIsMetered; } && exit 0

[ -d /subvols/1 ] && btrfs subvolume delete /subvols/1

if [ "$1" != "autoupdate" ] && [ "$1" != "update" ] && [ "$1" != "add" ] && [ "$1" != "del" ]; then
  echo 'usage:
  dpm install package_names
  dpm remove package_names
  dpm update'
  exit 1
fi

# create a snapshot of "/0" in "/1"
btrfs subvolume snapshot /0 /1

mount --bind /etc /1/etc
mount --bind /home /1/home
mount --bind /root /1/root
mount --bind /opt /1/opt
mount --bind /usr/local /1/usr/local
mount --bind /srv /1/srv
mount --bind /tmp /1/tmp
mount --bind /var /1/var
mount --bind /boot/efi /1/boot/efi

mount --bind /etc /0/etc
mount --bind /home /0/home
mount --bind /root /0/root
mount --bind /opt /0/opt
mount --bind / /0/usr/local
mount --bind /srv /0/srv
mount --bind /tmp /0/tmp
mount --bind /var /0/var
mount --bind /boot/efi /0/boot/efi

chroot /subvols/1 /usr/bin/sh << EOF
set -e
apt-get update
case "$1" in
  remove) shift; apt-get purge -- "$@" ;;
  install) shift; apt-get install --no-install-recommends -- "$@" ;;
  update) apt-get dist-upgrade ;;
  autoupdate) apt-get dist-upgrade --yes ;;
esac
apt-get autoremove --purge --yes
apt-get autoclean --yes
EOF

mv /1 /0
bootctl update --graceful --quiet --no-variables --esp-path=/boot/efi
